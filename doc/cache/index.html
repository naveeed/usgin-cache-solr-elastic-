<!DOCTYPE html><html lang="en"><head><title>cache/index</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="cache/index"><meta name="groc-project-path" content="cache/index.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">cache/index.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="cache-module">Cache Module</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">nano</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;nano&#39;</span><span class="p">),</span>
    <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;crypto&#39;</span><span class="p">),</span>
    <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">),</span>
    <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">),</span>
    <span class="nx">urls</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./urls&#39;</span><span class="p">),</span>
    <span class="nx">designDoc</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./design/usgin-cache&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="contructor">Contructor</h2>

<p>You should pass whether or not you want to refresh the cache and also a config obj.</p></div></div><div class="code"><div class="wrapper"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">forceRefresh</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">config</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">forceRefresh</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">?</span> <span class="nx">forceRefresh</span> <span class="o">:</span> <span class="nx">config</span><span class="p">;</span>
  <span class="nx">forceRefresh</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">forceRefresh</span> <span class="o">===</span> <span class="s1">&#39;boolean&#39;</span> <span class="o">?</span> <span class="nx">forceRefresh</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span>

  <span class="nx">config</span> <span class="o">=</span> <span class="nx">config</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">dbName</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">dbName</span> <span class="o">||</span> <span class="s1">&#39;usgin-cache&#39;</span><span class="p">;</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">dbUrl</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">dbUrl</span> <span class="o">||</span> <span class="s1">&#39;http://localhost:5984&#39;</span><span class="p">;</span>
  
  <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">nano</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">dbUrl</span><span class="p">),</span>
      <span class="nx">db</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">dbName</span><span class="p">);</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="private-functions">Private functions</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="control-how-we-identify-requests-in-the-cache">Control how we identify requests in the cache</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="kd">function</span> <span class="nx">getIdFor</span><span class="p">(</span><span class="nx">requestType</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">&#39;sha256&#39;</span><span class="p">);</span>
    <span class="nx">hash</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">url</span><span class="p">).</span><span class="nx">toUpperCase</span><span class="p">());</span>
    <span class="k">return</span> <span class="nx">hash</span><span class="p">.</span><span class="nx">digest</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="add-or-update-a-document-in-the-cache">Add or update a document in the cache</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="kd">function</span> <span class="nx">refreshDoc</span><span class="p">(</span><span class="nx">requestType</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">doc</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get the cache ID for this request</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">getIdFor</span><span class="p">(</span><span class="nx">requestType</span><span class="p">,</span> <span class="nx">url</span><span class="p">),</span>
    </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If a CouchDB doc was passed in, get its revision</p></div></div><div class="code"><div class="wrapper">    <span class="nx">rev</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">doc</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="nx">rev</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_rev</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
    </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If a doc was not passed, then we've got to get our function straight</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">doc</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">;</span>
    </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Now, request the URL</p></div></div><div class="code"><div class="wrapper">    <span class="nx">request</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the request failed, send back the error</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
      </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the request did not fail, build the cache document</p></div></div><div class="code"><div class="wrapper">      <span class="kd">var</span> <span class="nx">cacheDoc</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">_id</span><span class="o">:</span> <span class="nx">id</span><span class="p">,</span>
        <span class="nx">requestType</span><span class="o">:</span> <span class="nx">requestType</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">(),</span>
        <span class="nx">response</span><span class="o">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span>
        <span class="nx">endpoint</span><span class="o">:</span> <span class="nx">urls</span><span class="p">.</span><span class="nx">base</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
      <span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Need to capture featuretype for GetFeature requests</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="nx">requestType</span> <span class="o">===</span> <span class="s1">&#39;getfeature&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cacheDoc</span><span class="p">.</span><span class="nx">featuretype</span> <span class="o">=</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="sr">/typename=(.+?)(&amp;|$)/i</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">url</span><span class="p">)[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="p">}</span>
      </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Add the revision if a doc was passed in (if we're refreshing the cache)</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="nx">rev</span><span class="p">)</span> <span class="nx">cacheDoc</span><span class="p">[</span><span class="s1">&#39;_rev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rev</span><span class="p">;</span>
      </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Insert the document</p></div></div><div class="code"><div class="wrapper">      <span class="nx">db</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">cacheDoc</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">dbResponse</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the insert failed, send back the error</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
        </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Otherwise, send back the doc that's now cached</p></div></div><div class="code"><div class="wrapper">        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">cacheDoc</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="return-a-document-from-the-cache-adding-or-updating-as-neccessary">Return a document from the cache, adding or updating as neccessary</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="kd">function</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">requestType</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">refresh</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Valid requestTypes</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">validRequests</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;getrecords&#39;</span><span class="p">,</span> <span class="s1">&#39;getrecordbyid&#39;</span><span class="p">,</span> <span class="s1">&#39;getfeature&#39;</span><span class="p">,</span> <span class="s1">&#39;getcapabilities&#39;</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">validRequests</span><span class="p">,</span> <span class="nx">requestType</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()))</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;System will only cache &#39;</span> <span class="o">+</span> <span class="nx">validRequests</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; requests&#39;</span><span class="p">));</span>
    <span class="p">}</span>
    </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get the cache ID for this request</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">getIdFor</span><span class="p">(</span><span class="nx">requestType</span><span class="p">,</span> <span class="nx">url</span><span class="p">),</span>
    </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get our arguments straight</p></div></div><div class="code"><div class="wrapper">    <span class="nx">forceRefresh</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">refresh</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">refresh</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">refresh</span> <span class="o">===</span> <span class="s1">&#39;boolean&#39;</span><span class="p">)</span> <span class="nx">forceRefresh</span> <span class="o">=</span> <span class="nx">refresh</span><span class="p">;</span>
    
    <span class="nx">db</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Throw error if there was one, and it was not a 404</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span><span class="p">.</span><span class="nx">status_code</span> <span class="o">!==</span> <span class="mi">404</span><span class="p">)</span> <span class="p">{</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
      </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If we got a doc back, then return that</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">forceRefresh</span><span class="p">)</span> <span class="p">{</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">doc</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
      </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Either the doc has not been cached or we're being forced to refresh the cache</p></div></div><div class="code"><div class="wrapper">      <span class="nx">refreshDoc</span><span class="p">(</span><span class="nx">requestType</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">doc</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="public-api">Public API</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="k">return</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="access-to-the-cache-database">Access to the cache database</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="nx">db</span><span class="o">:</span> <span class="nx">db</span><span class="p">,</span>
    </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="csw-getrecords-request">CSW GetRecords request</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="nx">getRecords</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cswBaseUrl</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">limit</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">requestType</span> <span class="o">=</span> <span class="s1">&#39;getrecords&#39;</span><span class="p">,</span>
          <span class="nx">params</span> <span class="o">=</span> <span class="p">{};</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">start</span><span class="p">))</span> <span class="nx">params</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="nx">start</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">start</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">start</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">limit</span><span class="p">))</span> <span class="nx">params</span><span class="p">.</span><span class="nx">limit</span> <span class="o">=</span> <span class="nx">limit</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">limit</span> <span class="o">===</span> <span class="s1">&#39;function &#39;</span><span class="p">)</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">limit</span><span class="p">;</span>
      <span class="nx">callback</span> <span class="o">=</span> <span class="nx">callback</span> <span class="o">||</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>
      
      <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">urls</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">requestType</span><span class="p">,</span> <span class="nx">cswBaseUrl</span><span class="p">,</span> <span class="nx">params</span><span class="p">);</span>
      
      <span class="nx">fetch</span><span class="p">(</span><span class="nx">requestType</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">forceRefresh</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">},</span>
    </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="return-all-metadata-ids-from-a-particular-csw">Return all Metadata IDs from a particular CSW</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="nx">idsFromCsw</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cswBaseUrl</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">urls</span><span class="p">.</span><span class="nx">base</span><span class="p">(</span><span class="nx">cswBaseUrl</span><span class="p">);</span>
      <span class="nx">db</span><span class="p">.</span><span class="nx">view_with_list</span><span class="p">(</span><span class="s1">&#39;usgin-cache&#39;</span><span class="p">,</span> <span class="s1">&#39;metadataIds&#39;</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">key</span><span class="o">:</span> <span class="nx">url</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="csw-getrecordbyid-request">CSW GetRecordByID request</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="nx">getRecordById</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cswBaseUrl</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">requestType</span> <span class="o">=</span> <span class="s1">&#39;getrecordbyid&#39;</span><span class="p">,</span>
          <span class="nx">url</span> <span class="o">=</span> <span class="nx">urls</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">requestType</span><span class="p">,</span> <span class="nx">cswBaseUrl</span><span class="p">,</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="nx">id</span><span class="p">});</span>
      
      <span class="nx">callback</span> <span class="o">=</span> <span class="nx">callback</span> <span class="o">||</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>
      
      <span class="nx">fetch</span><span class="p">(</span><span class="nx">requestType</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">forceRefresh</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">},</span>
    </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="get-all-wfs-urls-available-in-the-cache">Get all WFS Urls available in the cache</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="nx">wfsUrls</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">db</span><span class="p">.</span><span class="nx">view_with_list</span><span class="p">(</span><span class="s1">&#39;usgin-cache&#39;</span><span class="p">,</span> <span class="s1">&#39;wfsUrls&#39;</span><span class="p">,</span> <span class="s1">&#39;threshold&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">min</span><span class="o">:</span><span class="mi">4</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="wfs-getcapabilities-request">WFS GetCapabilities request</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="nx">getCapabilities</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">wfsBaseUrl</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">requestType</span> <span class="o">=</span> <span class="s1">&#39;getcapabilities&#39;</span><span class="p">,</span>
          <span class="nx">url</span> <span class="o">=</span> <span class="nx">urls</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">requestType</span><span class="p">,</span> <span class="nx">wfsBaseUrl</span><span class="p">);</span>

      <span class="nx">fetch</span><span class="p">(</span><span class="nx">requestType</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">forceRefresh</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="wfs-getfeature-request">WFS GetFeature request</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="nx">getFeature</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">wfsBaseUrl</span><span class="p">,</span> <span class="nx">featureType</span><span class="p">,</span> <span class="nx">maxFeatures</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">requestType</span> <span class="o">=</span> <span class="s1">&#39;getfeature&#39;</span><span class="p">,</span>
          <span class="nx">params</span> <span class="o">=</span> <span class="p">{};</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">featureType</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="nx">params</span><span class="p">.</span><span class="nx">featureType</span> <span class="o">=</span> <span class="nx">featureType</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">featureType</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">featureType</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">maxFeatures</span><span class="p">))</span> <span class="nx">params</span><span class="p">.</span><span class="nx">maxFeatures</span> <span class="o">=</span> <span class="nx">maxFeatures</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">maxFeatures</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">maxFeatures</span><span class="p">;</span>
      <span class="nx">callback</span> <span class="o">=</span> <span class="nx">callback</span> <span class="o">||</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>
      
      <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">urls</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">requestType</span><span class="p">,</span> <span class="nx">wfsBaseUrl</span><span class="p">,</span> <span class="nx">params</span><span class="p">);</span>
      
      <span class="nx">fetch</span><span class="p">(</span><span class="nx">requestType</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">forceRefresh</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">},</span>
    </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="list-wfs-getfeature-responses-by-type">List WFS GetFeature responses by type</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="nx">wfsFeaturesByType</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">featuretype</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">featuretype</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">?</span> <span class="nx">featuretype</span> <span class="o">:</span> <span class="nx">callback</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">featuretype</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">?</span> <span class="p">{</span><span class="nx">key</span><span class="o">:</span> <span class="nx">featuretype</span><span class="p">}</span> <span class="o">:</span> <span class="p">{};</span>
      <span class="nx">db</span><span class="p">.</span><span class="nx">view</span><span class="p">(</span><span class="s1">&#39;usgin-cache&#39;</span><span class="p">,</span> <span class="s1">&#39;wfsFeaturesByType&#39;</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="clear-everything-except-design-documents-from-the-database">Clear everything except design documents from the database</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="nx">clear</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span> <span class="o">=</span> <span class="nx">callback</span> <span class="o">||</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>
      
      <span class="nx">db</span><span class="p">.</span><span class="nx">list</span><span class="p">({</span><span class="nx">include_docs</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
        
        <span class="kd">var</span> <span class="nx">docs</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">rows</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_design&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">});</span>
        
        <span class="nx">docs</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">docs</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">row</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span> <span class="nx">_deleted</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span> <span class="nx">row</span><span class="p">.</span><span class="nx">doc</span><span class="p">);</span>
        <span class="p">});</span>
        
        <span class="nx">db</span><span class="p">.</span><span class="nx">bulk</span><span class="p">({</span><span class="nx">docs</span><span class="o">:</span> <span class="nx">docs</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">},</span>
    </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="setup-the-database">Setup the database</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="nx">setup</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span> <span class="o">=</span> <span class="nx">callback</span> <span class="o">||</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>
      
      <span class="kd">function</span> <span class="nx">designDocs</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="s1">&#39;_design/usgin-cache&#39;</span><span class="p">;</span>
        
        <span class="nx">db</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span><span class="p">.</span><span class="nx">status_code</span> <span class="o">!==</span> <span class="mi">404</span><span class="p">)</span> <span class="p">{</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
          
          <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">db</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">designDoc</span><span class="p">,</span> <span class="p">{</span><span class="nx">_rev</span><span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_rev</span><span class="p">}),</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">db</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">designDoc</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">}</span>
      
      <span class="nx">connection</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">list</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">dbNames</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">dbNames</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">dbName</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">connection</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">dbName</span><span class="p">,</span> <span class="nx">designDocs</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">designDocs</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">};</span></div></div></div></div></body></html>